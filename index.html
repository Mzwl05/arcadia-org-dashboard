<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Organization Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <style>
    /* =============== Arcadia Brand Tokens =============== */
    :root{
      --dg1:#0c340a; --dg2:#30522e; --g1:#0c603f; --g2:#0e744e; --ga:#3e9071;
      --lime:#bac929; --lg:#d2df64;

      --bg:#f6f8f6;
      --panel:#ffffff;
      --border: rgba(12, 52, 10, 0.14);
      --border-strong: rgba(12, 52, 10, 0.26);
      --text:#0c340a;
      --muted: rgba(12, 52, 10, 0.62);
      --muted2: rgba(12, 52, 10, 0.45);
      --focus: rgba(186, 201, 41, 0.28);
      --wash: rgba(210, 223, 100, 0.10);
    }

    *{ box-sizing: border-box; }

    body{
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* =============== Top Bar =============== */
    .toolbar{
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .logo{
      height: 22px;
      width: auto;
      display:block;
    }

    .title-wrap{
      display:flex;
      flex-direction:column;
      gap: 2px;
      min-width: 0;
    }

    .toolbar h1{
      margin: 0;
      font-size: 15px;
      font-weight: 850;
      letter-spacing: -0.01em;
      color: var(--dg1);
      line-height: 1.1;
    }

    .subtitle{
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 55vw;
    }

    .actions{
      display:flex;
      align-items:center;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn, .select{
      appearance:none;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--dg1);
      padding: 7px 9px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 800;
      cursor:pointer;
      line-height: 1;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      white-space: nowrap;
    }

    .btn-primary{
      background: var(--g2);
      border-color: transparent;
      color: #fff;
    }
    .btn-primary:hover{ background: var(--g1); }

    .btn:focus, .select:focus{
      outline: none;
      box-shadow: 0 0 0 4px var(--focus);
      border-color: rgba(186, 201, 41, 0.75);
    }

    .zoom-pill{
      font-size: 11px;
      font-weight: 900;
      color: var(--muted);
      padding: 0 6px;
      min-width: 48px;
      text-align:center;
      user-select:none;
    }

    .zoom-group{
      display:flex;
      align-items:center;
      gap: 5px;
      padding: 5px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--panel);
    }

    /* =============== Main Area =============== */
    #viewport{
      flex: 1;
      overflow: hidden; /* key: we want to fit content inside */
      padding: 8px;
      position: relative;
    }

    /* We will scale this container to fit */
    #scaleWrap{
      transform-origin: top center;
      width: fit-content;
      margin: 0 auto;
    }

    /* The actual chart surface (natural size) */
    #chart{
      display: flex;
      flex-direction: column;
      gap: 10px; /* spacing between levels */
      padding: 6px 0 2px;
      align-items: center;
    }

    /* Level row */
    .level{
      display:flex;
      gap: 10px;              /* spacing between nodes */
      justify-content:center;
      align-items:flex-start;
      flex-wrap: nowrap;      /* keep each level on one row */
    }

    /* Card */
    .card{
      width: 120px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 8px 7px;
      text-align:center;
    }

    .name{
      font-size: 12px;
      font-weight: 900;
      line-height: 1.05;
      color: var(--dg1);
      margin-bottom: 2px;
      word-break: break-word;
    }

    .role{
      font-size: 10.5px;
      font-weight: 750;
      line-height: 1.1;
      color: var(--muted);
      word-break: break-word;
    }

    .accent{
      margin: 6px auto 0;
      height: 3px;
      width: 30px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--lime), var(--ga));
    }

    /* Status footer */
    #status{
      font-size: 11px;
      color: var(--muted);
      padding: 8px 12px;
      background: var(--panel);
      border-top: 1px solid var(--border);
      display:flex;
      justify-content:space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Print */
    @media print{
      .toolbar, #status{ display:none !important; }
      body{ background:#fff !important; }
      #viewport{ padding: 0 !important; }
      #scaleWrap{ transform: scale(1) !important; } /* JS will set a fit scale before print if desired */

      @page{
        size: letter landscape;
        margin: 0.30in;
      }
    }
  </style>
</head>

<body>
  <div class="toolbar">
    <div class="brand">
      <img class="logo" alt="Arcadia eFuels" src="https://arcadiaefuels.com/wp-content/uploads/2022/12/Arcadia-Identity.svg">
      <div class="title-wrap">
        <h1>Organization Dashboard</h1>
        <div class="subtitle" id="subtitle">Loading…</div>
      </div>
    </div>

    <div class="actions">
      <select class="select" id="tabSelect" title="Select organization view"></select>

      <div class="zoom-group" aria-label="Zoom controls">
        <button class="btn" id="zoomOutBtn" title="Zoom out">−</button>
        <div class="zoom-pill" id="zoomLabel">Fit</div>
        <button class="btn" id="zoomInBtn" title="Zoom in">+</button>
        <button class="btn" id="zoomFitBtn" title="Fit to window">Fit</button>
      </div>

      <a class="btn" id="sheetLink" href="#" target="_blank" rel="noopener noreferrer">Edit Spreadsheet</a>
      <button class="btn btn-primary" id="refreshBtn">Refresh</button>
    </div>
  </div>

  <div id="viewport">
    <div id="scaleWrap">
      <div id="chart"></div>
    </div>
  </div>

  <div id="status">
    <div id="statusLeft">Initializing…</div>
    <div id="statusRight"></div>
  </div>

  <script>
    // ====== Sheet config ======
    const SPREADSHEET_ID = "1oqcjp0sru7lC3Qt6XpiRt3uyCf0EHAjFx20VieZJUnU";
    const INDEX_SHEET_NAME = "INDEX";

    function sheetCsvUrlByName(sheetName){
      return "https://docs.google.com/spreadsheets/d/" + SPREADSHEET_ID +
             "/gviz/tq?tqx=out:csv&sheet=" + encodeURIComponent(sheetName);
    }

    document.getElementById("sheetLink").href =
      "https://docs.google.com/spreadsheets/d/" + SPREADSHEET_ID + "/edit";

    // ====== UI refs ======
    const tabSelect = document.getElementById("tabSelect");
    const subtitle = document.getElementById("subtitle");
    const statusLeft = document.getElementById("statusLeft");
    const statusRight = document.getElementById("statusRight");

    const viewport = document.getElementById("viewport");
    const scaleWrap = document.getElementById("scaleWrap");
    const chartEl = document.getElementById("chart");

    // ====== Zoom state ======
    let userZoom = null; // null means "auto-fit"
    let currentScale = 1;

    const zoomLabel = document.getElementById("zoomLabel");
    const ZOOM_STEP = 0.1;

    document.getElementById("zoomInBtn").addEventListener("click", () => {
      if (userZoom === null) userZoom = currentScale;
      userZoom = Math.min(2, +(userZoom + ZOOM_STEP).toFixed(2));
      applyScale(userZoom, "Manual");
    });

    document.getElementById("zoomOutBtn").addEventListener("click", () => {
      if (userZoom === null) userZoom = currentScale;
      userZoom = Math.max(0.2, +(userZoom - ZOOM_STEP).toFixed(2));
      applyScale(userZoom, "Manual");
    });

    document.getElementById("zoomFitBtn").addEventListener("click", () => {
      userZoom = null;
      fitToViewport();
    });

    document.getElementById("refreshBtn").addEventListener("click", () => {
      const tab = tabSelect.value;
      if (tab) loadOrgTab(tab);
    });

    // Re-fit on window resize (only if user not in manual zoom mode)
    window.addEventListener("resize", () => {
      if (userZoom === null) fitToViewport();
    });

    // ====== Startup ======
    loadIndexTabs();

    function setStatus(left, right){
      statusLeft.textContent = left || "";
      statusRight.textContent = right || "";
    }

    function loadIndexTabs() {
      subtitle.textContent = "Loading views…";
      setStatus("Fetching tabs…", "");

      Papa.parse(sheetCsvUrlByName(INDEX_SHEET_NAME), {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          const rows = (results && results.data) ? results.data : [];
          const tabs = rows.map(r => (r["Tab"] || "").trim()).filter(Boolean);

          if (!tabs.length) {
            chartEl.innerHTML = "<div style='padding:10px;color:#0c340a'>No tabs found. In INDEX tab, set A1=Tab and list TOPCO/ENDOR in column A.</div>";
            setStatus("INDEX is empty or missing 'Tab' column.", "");
            subtitle.textContent = "INDEX configuration needed";
            return;
          }

          tabSelect.innerHTML = "";
          tabs.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            tabSelect.appendChild(opt);
          });

          tabSelect.onchange = () => loadOrgTab(tabSelect.value);

          loadOrgTab(tabs[0]);
        },
        error: (err) => {
          console.error(err);
          chartEl.innerHTML = "<div style='padding:10px;color:#0c340a'>Error loading INDEX. Check publish/view permissions.</div>";
          setStatus("Failed to load INDEX.", "");
          subtitle.textContent = "Check sheet access";
        }
      });
    }

    function loadOrgTab(tabName) {
      subtitle.textContent = "Loading " + tabName + "…";
      setStatus("Fetching " + tabName + "…", "");
      chartEl.innerHTML = "";

      Papa.parse(sheetCsvUrlByName(tabName), {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          const data = (results && results.data) ? results.data : [];
          renderOrg(data, tabName);
        },
        error: (err) => {
          console.error(err);
          chartEl.innerHTML = "<div style='padding:10px;color:#0c340a'>Error loading " + escapeHtml(tabName) + " tab.</div>";
          setStatus("Failed to load " + tabName + ".", "");
          subtitle.textContent = "Load error";
        }
      });
    }

    function renderOrg(data, tabName){
      const people = normalizePeople(data);

      if (people.length === 0) {
        chartEl.innerHTML = "<div style='padding:10px;color:#0c340a'>No rows found in " + escapeHtml(tabName) + ".</div>";
        setStatus("No data in " + tabName + ".", "");
        subtitle.textContent = "Empty view";
        return;
      }

      // Build hierarchy
      const { roots, childrenMap } = buildHierarchy(people);

      // Create level rows (BFS)
      const levels = buildLevels(roots, childrenMap);

      // Render
      chartEl.innerHTML = "";
      levels.forEach(level => {
        const row = document.createElement("div");
        row.className = "level";
        level.forEach(p => row.appendChild(makeCard(p)));
        chartEl.appendChild(row);
      });

      const now = new Date();
      subtitle.textContent = "View: " + tabName;
      setStatus("Loaded " + people.length + " people.", "Updated: " + now.toLocaleString());

      // Fit automatically unless user manually zoomed
      if (userZoom === null) fitToViewport();
      else applyScale(userZoom, "Manual");
    }

    function normalizePeople(rows){
      return rows
        .map(r => ({
          name: (r["Employee Name"] || "").trim(),
          manager: (r["Manager Name"] || "").trim(),
          role: (r["Role"] || "").trim()
        }))
        .filter(p => p.name);
    }

    function buildHierarchy(people){
      const byName = new Map();
      people.forEach(p => byName.set(p.name, p));

      const childrenMap = new Map();
      function addChild(manager, child){
        if (!childrenMap.has(manager)) childrenMap.set(manager, []);
        childrenMap.get(manager).push(child);
      }

      // Track roots: those with no manager or manager missing
      const roots = [];
      people.forEach(p => {
        const m = p.manager;
        if (!m || !byName.has(m)) roots.push(p);
        else addChild(m, p);
      });

      // Keep stable-ish ordering
      for (const [k, arr] of childrenMap.entries()){
        arr.sort((a,b) => a.name.localeCompare(b.name));
      }
      roots.sort((a,b) => a.name.localeCompare(b.name));

      return { roots, childrenMap };
    }

    function buildLevels(roots, childrenMap){
      const levels = [];
      let current = roots.slice();
      const seen = new Set();

      // BFS by depth
      while (current.length){
        const next = [];
        const level = [];

        current.forEach(p => {
          if (seen.has(p.name)) return;
          seen.add(p.name);
          level.push(p);

          const kids = childrenMap.get(p.name) || [];
          kids.forEach(k => next.push(k));
        });

        if (level.length) levels.push(level);
        current = next;
      }
      return levels;
    }

    function makeCard(p){
      const card = document.createElement("div");
      card.className = "card";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = p.name;

      const role = document.createElement("div");
      role.className = "role";
      role.textContent = p.role;

      const accent = document.createElement("div");
      accent.className = "accent";

      card.appendChild(name);
      card.appendChild(role);
      card.appendChild(accent);
      return card;
    }

    function fitToViewport(){
      // Reset to natural size
      scaleWrap.style.transform = "scale(1)";
      const vw = viewport.clientWidth;
      const vh = viewport.clientHeight;

      // Measure natural size
      const rect = scaleWrap.getBoundingClientRect();
      const naturalW = rect.width;
      const naturalH = rect.height;

      // Compute scale to fit (with a tiny padding factor)
      const pad = 0.96;
      const scaleW = (vw / naturalW) * pad;
      const scaleH = (vh / naturalH) * pad;

      const scale = Math.min(scaleW, scaleH, 1); // never upscale above 1 in auto-fit
      applyScale(scale, "Fit");
    }

    function applyScale(scale, modeLabel){
      currentScale = scale;
      scaleWrap.style.transform = "scale(" + scale.toFixed(3) + ")";
      zoomLabel.textContent = (modeLabel === "Fit")
        ? "Fit"
        : Math.round(scale * 100) + "%";
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[s]));
    }

    // OPTIONAL: before printing, force-fit so it prints as one page as best as possible
    window.addEventListener("beforeprint", () => {
      userZoom = null;
      fitToViewport();
    });
  </script>
</body>
</html>
